par(mfrow = 1:2, mar = c(5,3.8,1,0) + 0.1, las = 3)
plot(loo_model2, label_points = TRUE)
model2 <- stan_glmer(occupancy ~ co2.rescaled + (1 | room),
data = X_train,
family=poisson,
cores = 4,
iter = 1000)
loo_model2 <- loo(model2)
model2 <- stan_glmer(occupancy ~ co2.rescaled + (1 | room),
data = X_train,
family=poisson,
cores = 4,
iter = 2000)
model2 <- stan_glmer(occupancy ~ co2.rescaled + (1 | room_category),
data = X_train,
family=poisson,
cores = 4,
iter = 1000)
library(rstanarm)
library(lme4)
library(ggplot2)
library(scales)
library(shinystan)
library(rethinking)
library(chron)
data = read.csv("data_co2_occ_num.csv")
colnames(data)[colnames(data) == 'sensor_name'] <- 'room'
summary(data)
data$co2.rescaled <- rescale(data$co2)
data$log_co2 <- scale(log(data$co2))
data$room_category = unclass(data$room)
data$time<-format(strptime(data$X, "%Y-%m-%d %H:%M:%S"), "%H:%M:%S")
breaks <- hour(hm("00:00", "6:00", "12:00", "16:00", "23:59"))
labels <- c("Night", "Morning", "Afternoon", "Evening")
data$time_cat <- cut(x=hour(data$X), breaks = breaks, labels = labels, include.lowest=TRUE)
data$time_cat_num <- unclass(data$time_cat)
train_index <- sample(1:nrow(data), 0.75 * nrow(data))
test_index <- setdiff(1:nrow(data), train_index)
# Build X_train, y_train, X_test, y_test
X_train <- data[train_index, -15]
X_test <- data[test_index, -15]
(hist <- ggplot(data, aes(x = occupancy)) +
geom_histogram(bins=100) +
theme_classic())
model1 <- glmer(formula = occupancy ~ 1 + co2.rescaled + (1 | room),
data = X_train,
family=poisson)
model_glm <- glm(occupancy ~ co2.rescaled + room,
data = X_train,
family=poisson)
round(coef(summary(model_glm)), 3)
round(coef(summary(model1)), 3)
model1 <- glmer(formula = occupancy ~ co2.rescaled + (1 | room),
data = X_train,
family=poisson)
round(coef(summary(model1)), 3)
1 +
model2 <- stan_glmer(occupancy ~ co2.rescaled + (1 | room_category),
data = X_train,
family=poisson,
cores = 4,
iter = 1000)
View(X_train)
model1 <- glmer(formula = occupancy ~ 1 + co2.rescaled + (1 | room),
data = X_train,
family=poisson)
model2 <- stan_glmer(occupancy ~ co2.rescaled + (1 | room_category),
data = X_train,
family=poisson,
cores = 4,
iter = 1000)
prior_summary(object = model2)
model2_posterior_prob <- posterior_interval(model2,
prob = 0.95)
round(model2_posterior_prob, 2)
summary(model1)
summary(model2)
round(coef(summary(model2)), 3)
plot(model2, plotfun = "trace")
y_pred <- posterior_predict(model2,
newdata=X_test)
loo_model2 <- loo(model2, k_threshold = 0.7)
par(mfrow = 1:2, mar = c(5,3.8,1,0) + 0.1, las = 3)
plot(loo_model2, label_points = TRUE)
loo_model2 <- loo(model2)
loo_model2 <- loo(model2, k_threshold = 0.7)
View(data)
loo_model2
sd(data$occupancy, na.rm = TRUE)
prior_summary(object = model2)
sd(data$occupancy, na.rm = TRUE)
model2 <- stan_glmer(occupancy ~ 1 + co2.rescaled + (1 | room_category),
data = X_train,
family=poisson,
seed = 334,
cores = 4,
iter = 1000)
prior_summary(object = model2)
sd(data$occupancy, na.rm = TRUE)
print(model2, digits = 2)
model1 <- lmer(formula = occupancy ~ 1 + co2.rescaled + (1 | room),
data = data,
family=poisson)
model1 <- glmer(formula = occupancy ~ 1 + co2.rescaled + (1 | room),
data = data,
family=poisson)
model1 <- glmer(formula = occupancy ~ 1 + co2.rescaled + (1 | room_category),
data = data,
family=poisson)
(summary(model1)), 3)
summary(model1)
model1 <- glmer(formula = occupancy ~ 1 + (1 | room_category),
data = data,
family=poisson)
summary(model1)
model1 <- lmer(formula = occupancy ~ 1 + (1 | room_category),
data = data,
family=poisson)
model1 <- glmer(formula = occupancy ~ 1 + (1 | room_category),
data = data,
family=poisson)
summary(model1)
model1 <- glmer(formula = occupancy ~ 1 + (1 | room_category),
data = data,
family=poisson)
summary(model1)
model2 <- glmer(occupancy ~ 1 + co2.rescaled + (1 | room_category),
data = X_train,
family=poisson,
seed = 334,
cores = 4,
iter = 1000)
model2 <- glmer(occupancy ~ 1 + co2.rescaled + (1 | room_category),
data = X_train,
family=poisson)
summary(model2)
model2 <- glmer(occupancy ~ 1 + co2.rescaled + (1 | room_category),
data = X_train,
family=poisson,
REML = FALSE)
summary(model2)
model2 <- glmer(occupancy ~ 1 + co2.rescaled + (1 | room_category),
data = X_train,
family=poisson)
summary(model2)
model1_stan <- stan_glmer(occupancy ~ 1 + (1 | room_category),
data = data,
family=poisson,
seed = 334,
cores = 4,
iter = 1000)
model1_stan <- stan_glmer(occupancy ~ 1 + (1 | room_category),
data = data,
family=poisson,
seed = 334)
prior_summary(object = model1_stan)
sd(data$occupancy, na.rm = TRUE)
print(model1_stan, digits = 2)
summary(model1_stan,
pars = c("(Intercept)", "sigma", "Sigma[room:(Intercept),(Intercept)]"),
probs = c(0.025, 0.975),
digits = 2)
print(model1_stan, digits = 2)
prior_summary(object = model1_stan)
prior_summary(object = model1_stan)
sd(data$occupancy, na.rm = TRUE)
print(model1_stan, digits = 2)
summary(model1_stan,
pars = c("(Intercept)", "sigma", "Sigma[room:(Intercept),(Intercept)]"),
probs = c(0.025, 0.975),
digits = 2)
mu_a_sims <- as.matrix(model1_stan,
pars = "(Intercept)")
# draws for 73 schools' school-level error
u_sims <- as.matrix(model1_stan,
regex_pars = "b\\[\\(Intercept\\) room\\:")
# draws for 73 schools' varying intercepts
a_sims <- as.numeric(mu_a_sims) + u_sims
# Obtain sigma_y and sigma_alpha^2
# draws for sigma_y
s_y_sims <- as.matrix(model1_stan,
pars = "sigma")
# draws for sigma_alpha^2
s__alpha_sims <- as.matrix(model1_stan,
pars = "Sigma[room:(Intercept),(Intercept)]")
a_mean <- apply(X = a_sims,     # posterior mean
MARGIN = 2,
FUN = mean)
a_sd <- apply(X = a_sims,       # posterior SD
MARGIN = 2,
FUN = sd)
para_name <- colnames(sims)
para_name
sims <- as.matrix(model1_stan)
para_name <- colnames(sims)
para_name
summary(model1_stan,
pars = c("(Intercept)", "sigma", "Sigma[room_category:(Intercept),(Intercept)]"),
probs = c(0.025, 0.975),
digits = 2)
mu_a_sims <- as.matrix(model1_stan,
pars = "(Intercept)")
# draws for 73 schools' school-level error
u_sims <- as.matrix(model1_stan,
regex_pars = "b\\[\\(Intercept\\) room_category\\:")
# draws for 73 schools' varying intercepts
a_sims <- as.numeric(mu_a_sims) + u_sims
# Obtain sigma_y and sigma_alpha^2
# draws for sigma_y
s_y_sims <- as.matrix(model1_stan,
pars = "sigma")
# draws for sigma_alpha^2
s__alpha_sims <- as.matrix(model1_stan,
pars = "Sigma[room_category:(Intercept),(Intercept)]")
a_mean <- apply(X = a_sims,     # posterior mean
MARGIN = 2,
FUN = mean)
a_sd <- apply(X = a_sims,       # posterior SD
MARGIN = 2,
FUN = sd)
# Posterior median and 95% credible interval
a_quant <- apply(X = a_sims,
MARGIN = 2,
FUN = quantile,
probs = c(0.025, 0.50, 0.975))
a_quant <- data.frame(t(a_quant))
names(a_quant) <- c("Q2.5", "Q50", "Q97.5")
# Combine summary statistics of posterior simulation draws
a_df <- data.frame(a_mean, a_sd, a_quant)
round(head(a_df), 2)
a_df <- a_df[order(a_df$a_mean), ]
a_df$a_rank <- c(1 : dim(a_df)[1])  # a vector of school rank
# Plot school-level alphas's posterior mean and 95% credible interval
ggplot(data = a_df,
aes(x = a_rank,
y = a_mean)) +
geom_pointrange(aes(ymin = Q2.5,
ymax = Q97.5),
position = position_jitter(width = 0.1,
height = 0)) +
geom_hline(yintercept = mean(a_df$a_mean),
size = 0.5,
col = "red") +
scale_x_continuous("Rank",
breaks = seq(from = 0,
to = 80,
by = 5)) +
scale_y_continuous(expression(paste("varying intercept, ", alpha[j]))) +
theme_bw( base_family = "serif")
####
room_diff <- a_sims[, 1] - a_sims[, 3]
sd <- sd(school_diff)
quantile <- quantile(school_diff, probs = c(0.025, 0.50, 0.975))
quantile <- data.frame(t(quantile))
names(quantile) <- c("Q2.5", "Q50", "Q97.5")
diff_df <- data.frame(mean, sd, quantile)
####
room_diff <- a_sims[, 1] - a_sims[, 3]
sd <- sd(room_diff)
quantile <- quantile(room_diff, probs = c(0.025, 0.50, 0.975))
quantile <- data.frame(t(quantile))
names(quantile) <- c("Q2.5", "Q50", "Q97.5")
diff_df <- data.frame(mean, sd, quantile)
round(diff_df, 2)
a_df$a_rank <- c(1 : dim(a_df)[1])  # a vector of school rank
round(head(a_df), 2)
model2_stan <- stan_glmer(occupancy ~ 1 + co2.rescaled + (1 | room_category),
data = data,
family=poisson,
seed = 334)
model2_posterior_prob <- posterior_interval(model2,
prob = 0.95)
prior_summary(object = model2)
print(model2, digits = 2)
model2_stan <- stan_glmer(occupancy ~ 1 + co2.rescaled + (1 | room_category),
data = data,
family=poisson,
seed = 334)
library(rstanarm)
library(lme4)
library(ggplot2)
library(scales)
library(shinystan)
library(rethinking)
library(chron)
data = read.csv("data_co2_occ_num.csv")
colnames(data)[colnames(data) == 'sensor_name'] <- 'room'
summary(data)
data$co2.rescaled <- rescale(data$co2)
data$log_co2 <- scale(log(data$co2))
data$room_category = unclass(data$room)
data$time<-format(strptime(data$X, "%Y-%m-%d %H:%M:%S"), "%H:%M:%S")
breaks <- hour(hm("00:00", "6:00", "12:00", "16:00", "23:59"))
labels <- c("Night", "Morning", "Afternoon", "Evening")
data$time_cat <- cut(x=hour(data$X), breaks = breaks, labels = labels, include.lowest=TRUE)
data$time_cat_num <- unclass(data$time_cat)
train_index <- sample(1:nrow(data), 0.75 * nrow(data))
test_index <- setdiff(1:nrow(data), train_index)
# Build X_train, y_train, X_test, y_test
X_train <- data[train_index, -15]
X_test <- data[test_index, -15]
(hist <- ggplot(data, aes(x = occupancy)) +
geom_histogram(bins=100) +
theme_classic())
model1 <- glmer(formula = occupancy ~ 1 + (1 | room_category),
data = data,
family=poisson)
summary(model1)
model2 <- glmer(occupancy ~ 1 + co2.rescaled + (1 | room_category),
data = data,
family=poisson)
summary(model2)
model1_stan <- stan_glmer(occupancy ~ 1 + (1 | room_category),
data = data,
family=poisson,
seed = 334)
prior_summary(object = model1_stan)
sd(data$occupancy, na.rm = TRUE)
print(model1_stan, digits = 2)
summary(model1_stan,
pars = c("(Intercept)", "sigma", "Sigma[room_category:(Intercept),(Intercept)]"),
probs = c(0.025, 0.975),
digits = 2)
mu_a_sims <- as.matrix(model1_stan,
pars = "(Intercept)")
# draws for 73 schools' school-level error
u_sims <- as.matrix(model1_stan,
regex_pars = "b\\[\\(Intercept\\) room_category\\:")
# draws for 73 schools' varying intercepts
a_sims <- as.numeric(mu_a_sims) + u_sims
# Obtain sigma_y and sigma_alpha^2
# draws for sigma_y
s_y_sims <- as.matrix(model1_stan,
pars = "sigma")
# draws for sigma_alpha^2
s__alpha_sims <- as.matrix(model1_stan,
pars = "Sigma[room_category:(Intercept),(Intercept)]")
a_mean <- apply(X = a_sims,     # posterior mean
MARGIN = 2,
FUN = mean)
a_sd <- apply(X = a_sims,       # posterior SD
MARGIN = 2,
FUN = sd)
# Posterior median and 95% credible interval
a_quant <- apply(X = a_sims,
MARGIN = 2,
FUN = quantile,
probs = c(0.025, 0.50, 0.975))
a_quant <- data.frame(t(a_quant))
names(a_quant) <- c("Q2.5", "Q50", "Q97.5")
# Combine summary statistics of posterior simulation draws
a_df <- data.frame(a_mean, a_sd, a_quant)
round(head(a_df), 2)
model2_stan <- stan_glmer(occupancy ~ 1 + co2.rescaled + (1 | room_category),
data = data,
family=poisson,
cores = 2,
iter = 500,
seed = 334)
prior_summary(object = model2)
model2_stan <- stan_glmer(occupancy ~ 1 + co2.rescaled + (1 | room_category),
data = data,
family=poisson,
cores = 2,
iter = 1000,
seed = 334)
model2_stan <- stan_glmer(occupancy ~ 1 + co2.rescaled + (1 | room_category),
data = data,
family=poisson,
cores = 5,
iter = 2000,
seed = 334)
model2_stan <- stan_glmer(occupancy ~ 1 + co2.rescaled + (1 | room_category),
data = data,
family=poisson,
adapt_delta = 0.99,
cores = 5,
iter = 2000,
seed = 334)
prior_summary(model2)
prior_summary(model2_stan)
priors <- prior_summary(model2_stan)
priors$prior$adjusted_scale
View(priors)
print(model2_stan, digits = 2)
model2_stan
model2_posterior_prob <- posterior_interval(model2,
prob = 0.95)
model2_posterior_prob <- posterior_interval(model2_stan,
prob = 0.95)
round(model2_posterior_prob, 2)
plot(model2_stan, "rhat")
plot(model2_stan, "ess")
plot(model2_stan, plotfun = "trace")
y_pred <- posterior_predict(model2_stan,
newdata=X_test)
loo_model2 <- loo(model2_stan, k_threshold = 0.7)
loo_model2
loo_model2 <- loo(model2_stan, k_threshold = 0.7, cores = getOption("mc.cores", 5))
loo_model2 <- loo(model2_stan, k_threshold = 0.7, cores = getOption("mc.cores", 4))
loo_model2 <- loo(model2_stan, k_threshold = 0.7)
loo_model2 <- loo(model2_stan, k_threshold = 0.7)
loo_model2
Sys.getenv("MC_CORES")
Sys.setenv("MC_CORES"=3L)
Sys.setenv("MC_CORES"=3L)
options("mc.cores")
library(parallel)
options("mc.cores")
Sys.setenv("MC_CORES"=3)
options("mc.cores")
Sys.setenv("MC_CORES"= 4)
Sys.getenv("MC_CORES")
getOption("mc.cores", 4)
kfold_model2_stan <- kfold(model2_stan, cores = getOption("mc.cores", 4))
kfold_model2_stan <- kfold(model2_stan, K=100, cores = getOption("mc.cores", 4))
kfold_model2_stan <- kfold(model2_stan, K=10000, cores = getOption("mc.cores", 4))
kfold_model2_stan <- kfold(model2_stan, K=1000, cores = getOption("mc.cores", 4))
par(mfrow = 1:2, mar = c(5,3.8,1,0) + 0.1, las = 3)
plot(loo_model2, label_points = TRUE)
plot(model2_stan)
pp_check(model2_stan, nreps=100)
pp_check(SingleLevelModel, nreps = 100)+ xlab("occupancy")
pp_check(model2_stan, nreps = 100)+ xlab("occupancy")
pp_check(model2_stan, nreps = 1000)+ xlab("occupancy")
pp_check(model2_stan)
pp_check(model2_stan, plotfun = "boxplot", nreps = 10, notch = FALSE)
pp_check(model2_stan, plotfun = "hist", nreps = 3)
loo_model2
par(mfrow = 1:2, mar = c(5,3.8,1,0) + 0.1, las = 3)
plot(loo_model2, label_points = TRUE)
plot(model2_stan)
round(model2_posterior_prob, 2)
print(model2_stan, digits = 2)
summary(model2_stan)
round(model2_posterior_prob, 2)
launch_shinystan(model2_stan, ppd = FALSE)
launch_shinystan(model2_stan, ppd = FALSE)
plot(loo_model2, label_points = TRUE)
bayesplot_grid(prop_zero_test1 + ggtitle("Poisson"),
prop_zero_test2 + ggtitle("Negative Binomial"),
grid_args = list(ncol = 2))
library(ggplot2)
library(bayesplot)
theme_set(bayesplot::theme_default())
prop_zero1 <- function(y) mean(y == 0)
prop_zero_test1 <- pp_check(post_model2_stan, plotfun = "stat", stat = "prop_zero", binwidth = .005, fun=NULL)
model2_stan_neg_bin <- stan_glmer(occupancy ~ 1 + co2.rescaled + (1 | room_category),
data = data,
family = neg_binomial_2,
adapt_delta = 0.99,
cores = 8,
iter = 2000,
seed = 12)
brm_zero_inflated_poisson_model_day <-
brm(data = data, family = zero_inflated_poisson,
occupancy ~ 1 + co2.rescaled + (1 | room) + (1 | day_of_week),
iter = 3000, cores = 1, control = list(adapt_delta = 0.9999999),
seed = 334)
library(rstanarm)
library(lme4)
library(ggplot2)
library(scales)
library(shinystan)
library(lubridate)
library(rethinking)
Sys.setenv("MC_CORES"= 8)
Sys.getenv("MC_CORES")
getOption("mc.cores", 8)
setwd("C:/Users/mam/PycharmProjects/SmartBuldings/Hierarchical models")
data = read.csv("data_co2_occ_num.csv")
colnames(data)[colnames(data) == 'sensor_name'] <- 'room'
summary(data)
data$co2.rescaled <- rescale(data$co2)
data$log_co2 <- scale(log(data$co2))
data$room_category = unclass(data$room)
data$day_of_week <- factor(weekdays(as.Date(data$X)))
data$day_of_week_cat = unclass(factor(weekdays(as.Date(data$X))))
data$time<-format(strptime(data$X, "%Y-%m-%d %H:%M:%S"), "%H:%M:%S")
weekdays <- c('Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday')
data$weekday <- factor((weekdays(as.Date(data$X)) %in% weekdays), levels=c(FALSE, TRUE), labels=c('weekend', 'weekday'))
breaks <- hour(hm("00:00", "6:00", "11:00", "14:00", "17:00", "23:59"))
labels <- c("Night", "Morning", "Afternoon","Late afternoon", "Evening")
data$time_cat <- cut(x=hour(data$X), breaks = breaks, labels = labels, include.lowest=TRUE)
library(brms)
library(tidyverse)
brm_zero_inflated_poisson_model_day <-
brm(data = data, family = zero_inflated_poisson,
occupancy ~ 1 + co2.rescaled + (1 | room) + (1 | day_of_week),
iter = 3000, cores = 1, control = list(adapt_delta = 0.9999999),
seed = 334)
save.image("C:/Users/mam/PycharmProjects/SmartBuldings/Hierarchical models/dd.RData")
save.image("C:/Users/mam/PycharmProjects/SmartBuldings/Hierarchical models/dd.RData")
fitted(brm_zero_inflated_poisson_model_day) %>%
as_tibble() %>%
bind_cols(data)  %>%
ggplot(aes(x = occupancy, y = Estimate)) +
geom_abline(linetype = 2, color = "grey", size = .5) +
geom_point(size = 1.5, color = "darkred", alpha = 3/4) +
geom_linerange(aes(ymin = Q2.5, ymax = Q97.5),
size = 1/4, color = "darkred") +
geom_linerange(aes(ymin = Estimate - Est.Error,
ymax = Estimate + Est.Error),
size = 1/2, color = "darkred") +
labs(x = "Observed occupancy",
y = "Predicted occupancy in Poisson model") +
theme_bw() +
theme(panel.grid = element_blank())
summary(brm_zero_inflated_poisson_model_day)
mcmc_plot(brm_zero_inflated_poisson_model_day)
loo_model2_zero_inflated_poisson_model_day <- loo(brm_zero_inflated_poisson_model_day, k_threshold = 0.7, cores = 1)
loo_model2_zero_inflated_poisson_model_day <- loo(brm_zero_inflated_poisson_model_day, k_threshold = 0.7, cores = 1, reloo = TRUE)
